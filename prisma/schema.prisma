// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Agent {
  id          String    @id @default(uuid())
  firstName   String    @map("first_name")
  lastName    String    @map("last_name")
  jobTitle    String?   @map("job_title")
  companyName String?   @map("company_name")
  email       String    @unique
  emailOptOut Boolean   @default(false) @map("email_opt_out")
  phone1      String?
  phone2      String?
  fax         String?
  
  // Location Information
  address     String?
  city        String?
  state       String?
  country     String?
  zipCode     String?   @map("zip_code")
  
  // Additional Fields
  deals       String[]  @default([])
  dateOfBirth DateTime? @map("date_of_birth")
  reviews     Decimal?  @db.Decimal(3, 2)
  owner       String?
  tags        String[]  @default([])
  source      String?
  industry    String?
  currency    String?
  language    String?
  description String?   @db.Text
  
  // Status & Rating
  status      String    @default("Active")
  rating      Decimal?  @db.Decimal(3, 2)
  
  // Image
  image       String?
  
  // Agent-Specific Fields
  licenseNumber       String?   @map("license_number")
  licenseExpiryDate   DateTime? @map("license_expiry_date")
  brokerageStartDate  DateTime? @map("brokerage_start_date")
  teamOffice          String?   @map("team_office")
  commissionSplit     Json?     @map("commission_split") // JSON for flexible commission structure
  bankingInfo         Json?     @map("banking_info") // Encrypted banking information
  emergencyContact    Json?     @map("emergency_contact") // { name, phone, relationship, email? }
  notes               String?   @db.Text // Internal comments/notes
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  onboarding  AgentOnboarding?
  tasks       Task[]

  @@map("agents")
}

// ============================================
// Agent Onboarding System
// ============================================

model AgentOnboarding {
  id                    String    @id @default(uuid())
  agentId               String    @unique @map("agent_id")
  agent                 Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  // Onboarding Status
  status                String    @default("Invited") // Invited, Onboarding Started, Profile Complete, Compliance Pending, Awaiting Approval, Active, Suspended, Terminated
  onboardingStartedAt   DateTime? @map("onboarding_started_at")
  completedAt           DateTime? @map("completed_at")
  activatedAt           DateTime? @map("activated_at")
  activatedBy           String?   @map("activated_by") // Admin user ID
  
  // Invitation
  invitationToken       String?   @unique @map("invitation_token")
  invitationSentAt      DateTime? @map("invitation_sent_at")
  invitationExpiresAt   DateTime? @map("invitation_expires_at")
  invitationAcceptedAt  DateTime? @map("invitation_accepted_at")
  invitedBy             String?   @map("invited_by") // Admin user ID
  
  // Role & Assignment
  role                  String?   // Salesperson, Broker, Team Leader
  assignedOffice        String?   @map("assigned_office")
  assignedTeam          String?   @map("assigned_team")
  
  // Profile Completion
  profileCompleted      Boolean   @default(false) @map("profile_completed")
  profileCompletedAt    DateTime? @map("profile_completed_at")
  
  // Compliance Status
  complianceStatus      String?   @map("compliance_status") // Pending, In Review, Approved, Rejected
  complianceCompletedAt DateTime? @map("compliance_completed_at")
  
  // Training Status
  trainingCompleted     Boolean   @default(false) @map("training_completed")
  trainingCompletedAt   DateTime? @map("training_completed_at")
  
  // Financial Setup
  financialSetup        Boolean   @default(false) @map("financial_setup")
  financialApprovedAt   DateTime? @map("financial_approved_at")
  financialApprovedBy   String?   @map("financial_approved_by")
  
  // Admin Notes
  adminNotes            String?   @db.Text @map("admin_notes")
  
  // Pipeline Integration
  pipelineId            String?   @map("pipeline_id")
  pipeline              Pipeline? @relation(fields: [pipelineId], references: [id], onDelete: SetNull)
  currentStageId        String?   @map("current_stage_id")
  currentStage          PipelineStage? @relation(fields: [currentStageId], references: [id], onDelete: SetNull)
  
  // Stage progression tracking
  stageEnteredAt        DateTime? @map("stage_entered_at")
  stageCompletedAt      DateTime? @map("stage_completed_at")
  
  // Timestamps
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  // Relations
  checklist             OnboardingChecklist[]
  documents             OnboardingDocument[]
  agreements            OnboardingAgreement[]
  training              OnboardingTraining[]
  auditLogs             OnboardingAuditLog[]
  
  @@index([pipelineId])
  @@index([currentStageId])
  @@map("agent_onboarding")
}

model OnboardingChecklist {
  id              String    @id @default(uuid())
  onboardingId    String    @map("onboarding_id")
  onboarding      AgentOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade)
  
  step            String    // Step identifier (e.g., "profile", "compliance", "training")
  stepName        String    @map("step_name")
  stepOrder       Int       @map("step_order")
  isRequired      Boolean   @default(true) @map("is_required")
  isCompleted     Boolean   @default(false) @map("is_completed")
  completedAt     DateTime? @map("completed_at")
  completedBy     String?   @map("completed_by") // User ID (agent or admin)
  
  // Step-specific data
  stepData        Json?     @map("step_data")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@index([onboardingId])
  @@map("onboarding_checklist")
}

model OnboardingDocument {
  id              String    @id @default(uuid())
  onboardingId    String    @map("onboarding_id")
  onboarding      AgentOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade)
  
  documentType    String    @map("document_type") // RECO, E&O Insurance, FINTRAC, PIPEDA, Government ID, etc.
  documentName    String    @map("document_name")
  fileName        String    @map("file_name")
  filePath        String    @map("file_path") // Encrypted storage path
  fileSize        Int?      @map("file_size")
  mimeType        String?   @map("mime_type")
  
  // Expiry & Compliance
  expiryDate      DateTime? @map("expiry_date")
  isExpired       Boolean   @default(false) @map("is_expired")
  isRequired      Boolean   @default(true) @map("is_required")
  
  // Status
  status          String    @default("Pending") // Pending, Approved, Rejected
  statusChangedAt DateTime? @map("status_changed_at")
  statusChangedBy String?   @map("status_changed_by") // Admin user ID
  
  // Admin Review
  adminNotes      String?   @db.Text @map("admin_notes")
  rejectionReason String?   @db.Text @map("rejection_reason")
  
  // Version Control
  version         Int       @default(1)
  previousVersion String?   @map("previous_version") // Reference to previous version ID
  
  // Upload Info
  uploadedBy     String?   @map("uploaded_by") // User ID
  uploadedAt     DateTime  @default(now()) @map("uploaded_at")
  uploadIp       String?   @map("upload_ip")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@index([onboardingId])
  @@index([documentType])
  @@index([expiryDate])
  @@index([status])
  @@map("onboarding_documents")
}

model OnboardingAgreement {
  id              String    @id @default(uuid())
  onboardingId    String    @map("onboarding_id")
  onboarding      AgentOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade)
  
  agreementType   String    @map("agreement_type") // Independent Contractor, Brokerage Policies, Code of Ethics, AML Policy
  agreementName   String    @map("agreement_name")
  
  // Document Reference
  documentId      String?   @map("document_id") // Reference to OnboardingDocument if stored as file
  documentVersion String?   @map("document_version")
  
  // E-Signature
  signedBy        String?   @map("signed_by") // Agent user ID
  signedAt        DateTime? @map("signed_at")
  signatureIp     String?   @map("signature_ip")
  signatureData   Json?     @map("signature_data") // Signature image/data
  
  // Status
  status          String    @default("Pending") // Pending, Signed, Expired
  isRequired      Boolean   @default(true) @map("is_required")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@index([onboardingId])
  @@index([agreementType])
  @@map("onboarding_agreements")
}

model OnboardingTraining {
  id              String    @id @default(uuid())
  onboardingId    String    @map("onboarding_id")
  onboarding      AgentOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade)
  
  trainingType    String    @map("training_type") // Brokerage Policies, Compliance, CRM Usage, Marketing Guidelines
  trainingName    String    @map("training_name")
  trainingUrl     String?   @map("training_url") // Link to training material
  
  // Completion
  isCompleted     Boolean   @default(false) @map("is_completed")
  completedAt     DateTime? @map("completed_at")
  completedBy     String?   @map("completed_by") // Agent user ID
  
  // Optional Quiz/Assessment
  quizScore       Decimal?  @db.Decimal(5, 2) @map("quiz_score")
  quizPassed      Boolean?  @map("quiz_passed")
  quizAttempts    Int       @default(0) @map("quiz_attempts")
  
  // Requirements
  isRequired      Boolean   @default(true) @map("is_required")
  isMandatory     Boolean   @default(true) @map("is_mandatory")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@index([onboardingId])
  @@index([trainingType])
  @@map("onboarding_training")
}

model OnboardingAuditLog {
  id              String    @id @default(uuid())
  onboardingId    String    @map("onboarding_id")
  onboarding      AgentOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade)
  
  action          String    // Action performed (e.g., "status_changed", "document_uploaded", "agreement_signed")
  actionType      String    @map("action_type") // status_change, document_upload, document_approval, agreement_signature, etc.
  description     String?   @db.Text
  
  // Actor
  performedBy     String?   @map("performed_by") // User ID
  performedByRole String?   @map("performed_by_role") // Admin, Agent
  ipAddress       String?   @map("ip_address")
  
  // Changes
  oldValue        Json?     @map("old_value")
  newValue        Json?     @map("new_value")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  
  @@index([onboardingId])
  @@index([actionType])
  @@index([createdAt])
  @@map("onboarding_audit_logs")
}

// ============================================
// Tasks Module
// ============================================

// Pre-defined task templates that can be assigned to agents
model TaskTemplate {
  id          String    @id @default(uuid())
  name        String    // Task name/title
  description String?   @db.Text
  category    String?   // e.g., "Onboarding", "Training", "Compliance", "General"
  priority    String    @default("Medium") // Low, Medium, High, Urgent
  estimatedDuration Int? @map("estimated_duration") // in minutes
  isActive    Boolean   @default(true) @map("is_active")
  order       Int       @default(0) // Display order
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  createdBy   String?   @map("created_by") // User ID
  
  // Relations
  tasks       Task[]
  taskSets    TaskSetTemplate[] // Many-to-many with TaskSet
  
  @@index([isActive])
  @@index([category])
  @@map("task_templates")
}

// Task Sets - Collections of task templates that can be assigned together
model TaskSet {
  id          String    @id @default(uuid())
  name        String    // Set name (e.g., "Onboarding Set", "Compliance Set")
  description String?   @db.Text
  category    String?   // e.g., "Onboarding", "Training", "Compliance"
  isActive    Boolean   @default(true) @map("is_active")
  order       Int       @default(0) // Display order
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  createdBy   String?   @map("created_by") // User ID
  
  // Relations
  templates       TaskSetTemplate[] // Many-to-many with TaskTemplate
  pipelineStages  PipelineStageTaskSet[] // Many-to-many with PipelineStage
  
  @@index([isActive])
  @@index([category])
  @@map("task_sets")
}

// Join table for many-to-many relationship between TaskSet and TaskTemplate
model TaskSetTemplate {
  id          String    @id @default(uuid())
  taskSetId   String    @map("task_set_id")
  taskSet     TaskSet   @relation(fields: [taskSetId], references: [id], onDelete: Cascade)
  templateId  String    @map("template_id")
  template    TaskTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  order       Int       @default(0) // Order within the set
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  
  @@unique([taskSetId, templateId]) // Prevent duplicate templates in same set
  @@index([taskSetId])
  @@index([templateId])
  @@map("task_set_templates")
}

// Individual task instances linked to agents (and potentially other modules)
model Task {
  id          String    @id @default(uuid())
  
  // Task Information
  title       String
  description String?   @db.Text
  category    String?   // Inherited from template or custom
  priority    String    @default("Medium") // Low, Medium, High, Urgent
  status      String    @default("Pending") // Pending, In Progress, Completed, Cancelled
  
  // Assignment
  agentId     String?   @map("agent_id") // Link to agent
  agent       Agent?    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  // Template Reference (optional - for tracking which template was used)
  templateId  String?   @map("template_id")
  template    TaskTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  
  // Completion Tracking
  isCompleted Boolean   @default(false) @map("is_completed")
  completedAt DateTime? @map("completed_at")
  completedBy String?   @map("completed_by") // User ID
  
  // Due Date
  dueDate     DateTime? @map("due_date")
  
  // Additional Metadata
  tags        String[]  @default([])
  notes       String?   @db.Text
  
  // Assignment Info
  assignedBy  String?   @map("assigned_by") // User ID who assigned the task
  assignedAt  DateTime  @default(now()) @map("assigned_at")
  
  // Stage tracking (for pipeline-based onboarding)
  stageId     String?   @map("stage_id")
  stage       PipelineStage? @relation(fields: [stageId], references: [id], onDelete: SetNull)
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  @@index([agentId])
  @@index([templateId])
  @@index([stageId])
  @@index([status])
  @@index([isCompleted])
  @@index([dueDate])
  @@index([createdAt])
  @@map("tasks")
}

// ============================================
// Pipeline Module
// ============================================

model Pipeline {
  id          String    @id @default(uuid())
  name        String    @map("name")
  description String?   @db.Text
  status      String    @default("Active") // Active, Inactive
  accessType  String    @default("All") @map("access_type") // All, Selected
  createdBy   String?   @map("created_by")
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // Relations
  stages      PipelineStage[]
  accessUsers PipelineAccessUser[]
  onboardingRecords AgentOnboarding[] // Agents in this pipeline
  
  @@index([status])
  @@index([accessType])
  @@index([createdAt])
  @@map("pipelines")
}

model PipelineStage {
  id          String    @id @default(uuid())
  pipelineId  String    @map("pipeline_id")
  pipeline    Pipeline  @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  
  name        String
  order       Int       @default(0)
  color       String?   // Hex color code for UI display
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // Relations
  taskSets            PipelineStageTaskSet[] // Many-to-many with TaskSet
  onboardingRecords   AgentOnboarding[] // Agents currently in this stage
  tasks               Task[] // Tasks assigned in this stage
  
  @@index([pipelineId])
  @@index([order])
  @@map("pipeline_stages")
}

model PipelineAccessUser {
  id          String    @id @default(uuid())
  pipelineId  String    @map("pipeline_id")
  pipeline    Pipeline  @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  
  userId      String    @map("user_id")
  userName    String?   @map("user_name")
  userEmail   String?   @map("user_email")
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  
  @@unique([pipelineId, userId])
  @@index([pipelineId])
  @@index([userId])
  @@map("pipeline_access_users")
}

// Join table for many-to-many relationship between PipelineStage and TaskSet
model PipelineStageTaskSet {
  id            String    @id @default(uuid())
  stageId       String    @map("stage_id")
  stage         PipelineStage @relation(fields: [stageId], references: [id], onDelete: Cascade)
  taskSetId     String    @map("task_set_id")
  taskSet       TaskSet   @relation(fields: [taskSetId], references: [id], onDelete: Cascade)
  order         Int       @default(0) // Order if multiple task sets per stage
  isRequired    Boolean   @default(true) @map("is_required")
  
  // Stage-specific task deadlines
  defaultDueDays Int?     @map("default_due_days") // Days from stage entry to task due date
  
  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  
  @@unique([stageId, taskSetId]) // Prevent duplicate task sets in same stage
  @@index([stageId])
  @@index([taskSetId])
  @@map("pipeline_stage_task_sets")
}

// ============================================
// User Management System
// ============================================

model User {
  id          String    @id @default(uuid())
  username    String    @unique
  email       String    @unique
  emailOptOut Boolean   @default(false) @map("email_opt_out")
  firstName   String    @map("first_name")
  lastName    String?   @map("last_name")
  
  // Authentication
  passwordHash String   @map("password_hash") // Hashed password (bcrypt)
  
  // Contact Information
  phone1      String?
  phone2      String?
  
  // Location
  location    String?   // Location/Address
  
  // Profile
  image       String?   // Profile image path
  status      String    @default("Active") // Active, Inactive, Suspended
  
  // Relations
  roleId      String?   @map("role_id")
  role        Role?     @relation(fields: [roleId], references: [id], onDelete: SetNull)
  deleteRequests DeleteRequest[]
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")
  
  @@index([email])
  @@index([username])
  @@index([roleId])
  @@index([status])
  @@index([createdAt])
  @@map("users")
}

model Role {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?   @db.Text
  isActive    Boolean   @default(true) @map("is_active")
  
  // Relations
  users       User[]
  permissions RolePermission[] // Many-to-many with Permission
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  createdBy   String?   @map("created_by") // User ID
  
  @@index([isActive])
  @@index([name])
  @@map("roles")
}

model Permission {
  id          String    @id @default(uuid())
  name        String    @unique // e.g., "users.create", "agents.view", "tasks.edit"
  description String?   @db.Text
  category    String?   // e.g., "Users", "Agents", "Tasks", "Pipelines"
  isActive    Boolean   @default(true) @map("is_active")
  
  // Relations
  roles       RolePermission[] // Many-to-many with Role
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  @@index([isActive])
  @@index([category])
  @@index([name])
  @@map("permissions")
}

// Join table for many-to-many relationship between Role and Permission
model RolePermission {
  id           String    @id @default(uuid())
  roleId       String    @map("role_id")
  role         Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String    @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt    DateTime  @default(now()) @map("created_at")
  grantedBy    String?   @map("granted_by") // User ID who granted this permission
  
  @@unique([roleId, permissionId]) // Prevent duplicate permissions for same role
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// ============================================
// Delete Request System
// ============================================

model DeleteRequest {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  reason          String?   @db.Text
  status          String    @default("Pending") // Pending, Approved, Rejected
  requestedAt     DateTime  @default(now()) @map("requested_at")
  reviewedAt      DateTime? @map("reviewed_at")
  reviewedBy      String?   @map("reviewed_by") // Admin user ID
  reviewNotes     String?   @db.Text @map("review_notes")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@index([userId])
  @@index([status])
  @@index([requestedAt])
  @@map("delete_requests")
}
